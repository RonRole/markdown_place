# api開発環境用docker
FROM php:8.2

RUN apt-get update && apt-get install -y \
    git \
    zip \
    unzip \
    # pdo_pgsqlに必要
    libpq-dev

# php->postgres接続用ドライバー
RUN docker-php-ext-install pdo_pgsql

COPY --from=composer /usr/bin/composer /usr/bin/composer
RUN composer self-update --2

WORKDIR /app
COPY ./src /app
# メモリ不足の対策に、一時的にCOMPOSER_MEMORY_LIMIT
RUN COMPOSER_MEMORY_LIMIT=-1 $(which composer) update

# 環境変数を設定(環境ごとに書き換えたいもの)
ARG APP_ENV
ARG FRONT_ORIGIN
ARG DB_CONNECTION
ARG DB_HOST
ARG DB_PORT
ARG DB_DATABASE
ARG DB_USERNAME
ARG DB_PASSWORD
ARG SESSION_DRIVER
ARG SESSION_LIFETIME
ARG REDIS_HOST
ARG REDIS_PASSWORD
ARG REDIS_PORT
ARG REDIS_SCHEME

ENV APP_ENV $APP_ENV
ENV FRONT_ORIGIN $FRONT_ORIGIN
ENV DB_CONNECTION $DB_CONNECTION
ENV DB_HOST $DB_HOST
ENV DB_PORT $DB_PORT
ENV DB_DATABASE $DB_DATABASE
ENV DB_USERNAME $DB_USERNAME
ENV DB_PASSWORD $DB_PASSWORD
ENV SESSION_DRIVER $SESSION_DRIVER
ENV SESSION_LIFETIME $SESSION_LIFETIME
ENV REDIS_HOST $REDIS_HOST
ENV REDIS_PASSWORD $REDIS_PASSWORD
ENV REDIS_PORT $REDIS_PORT
ENV REDIS_SCHEME $REDIS_SCHEME

EXPOSE 8000
CMD ["php", "artisan", "serve", "--host", "0.0.0.0"]